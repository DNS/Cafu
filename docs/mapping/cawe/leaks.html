
<h1 class="sectionedit1" id="dealing_with_leaks">Dealing with Leaks</h1>
<div class="level1">

<p>
This section explains what a leak is, why leaks are important, how they are found and fixed, and how leaks are prevented.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Dealing with Leaks&quot;,&quot;hid&quot;:&quot;dealing_with_leaks&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-158&quot;} -->
<h2 class="sectionedit2">What is a Leak?</h2>
<div class="level2">

<p>
Maps created for the Cafu engine are preprocessed by several compile tools (e.g. <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr>, <abbr title="Cafu Potentially Visibility Set">CaPVS</abbr>, <abbr title="Cafu Radiosity Lighting">CaLight</abbr>) for optimal performance. These compile tools assume that any map has an inside (where the player and monsters are), and an outside that nobody except for the mapper will ever see. The inside must be <em>sealed “air-tight” or “water-tight”</em> from the outside.
</p>

<p>
That is, if you imagine you flood-filled the map from the inside with water or pressurized air, at no point must the water or air be able to escape to the outside. Therefore, each place where that would be possible is called a <em>leak</em>.
</p>

<p>
<em> “A leak is a hole in the world, where the inside of it is exposed to the (unwanted) outside region.” </em> – <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> error message when a leak was found.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;What is a Leak?&quot;,&quot;hid&quot;:&quot;what_is_a_leak&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;159-942&quot;} -->
<h2 class="sectionedit3">Examples for Leaks</h2>
<div class="level2">

<p>
<a href="/_detail/mapping:cawe:leak_example_gaps.png?id=mapping%3Acawe%3Aleaks" class="media" title="mapping:cawe:leak_example_gaps.png"><img src="/_media/mapping:cawe:leak_example_gaps.png" class="mediaright" title="A leak caused by an obvious gap." alt="A leak caused by an obvious gap." /></a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Examples for Leaks&quot;,&quot;hid&quot;:&quot;examples_for_leaks&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;943-1048&quot;} -->
<h3 class="sectionedit4">Gaps in the geometry</h3>
<div class="level3">

<p>
The example to the right shows a leak that is caused by an obvious gap in the geometry that leads to the void (the outer region). This is the classical example and most common type of leaks, and such leaks are usually easy to find and fix.
</p>

<p>
However, note that gaps like these can be very small, and often they&#039;re somewhere inside complex geometry. Don&#039;t hesitate to zoom close whenever the situation is not as obvious as in this example.
<br style="clear:both" />
</p>

<p>
<a href="/_detail/mapping:cawe:leak_example_materials.png?id=mapping%3Acawe%3Aleaks" class="media" title="mapping:cawe:leak_example_materials.png"><img src="/_media/mapping:cawe:leak_example_materials.png" class="mediaright" title="A leak caused by translucent materials on outside walls." alt="A leak caused by translucent materials on outside walls." /></a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Gaps in the geometry&quot;,&quot;hid&quot;:&quot;gaps_in_the_geometry&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1049-1631&quot;} -->
<h3 class="sectionedit5">Inappropriate materials on outside walls</h3>
<div class="level3">

<p>
Materials that are see-through (like the grate in the center of the image) or translucent (like the glass pane to the right) cannot be used on outside walls as is this example, because such materials obviously don&#039;t seal the map.
</p>

<p>
To fix the problem, you either have to replace such materials with other materials that are solid, or make another room that has solid walls on the other side of (“behind”) these surfaces.
</p>

<p>
Note that contrary to the materials shown in this example, <em>skydome</em> materials <strong>do</strong> seal the map.
</p>

<p>
<img src="/lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> How you do know which materials seal the map and which don&#039;t? <br/>
→ Only those materials that have the <code>bspPortals</code> <a href="/matsys:cmat_manual:keywordreference#other_keywords" class="wikilink1" title="matsys:cmat_manual:keywordreference">clip flag</a> set in their material definition seal the map, all others don&#039;t. Future versions of <abbr title="Cafu World Editor">CaWE</abbr> will directly indicate the status of this flag in the Material Browser, but currently you have to look-up the definition of a material in its <code>.<abbr title="Cafu material script file.">cmat</abbr></code> file to find out the status of this flag. Good news though is that most materials behave totally naturally: <br/>
<img src="/lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> <em>As a rule of thumb, if <em class="u">you</em> can see through, then <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> can see through, too, and thus such materials cannot be used on outside walls.</em>
<br style="clear:both" />
</p>

<p>
<a href="/_detail/mapping:cawe:leak_example_terrains.png?id=mapping%3Acawe%3Aleaks" class="media" title="mapping:cawe:leak_example_terrains.png"><img src="/_media/mapping:cawe:leak_example_terrains.png" class="mediaright" title="Terrains don&#039;t seal the map, the caulk material must be employed." alt="Terrains don&#039;t seal the map, the caulk material must be employed." /></a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Inappropriate materials on outside walls&quot;,&quot;hid&quot;:&quot;inappropriate_materials_on_outside_walls&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;1632-3013&quot;} -->
<h3 class="sectionedit6">Terrains, Bezier Patches and Entities</h3>
<div class="level3">

<p>
Terrain and Bezier Patch primites <em>never</em> seal the map, even if their material is solid.
Therefore, if you dragged the terrain in this example to cover the entire floor, you still cannot expect it to prevent the map from leaking.
</p>

<p>
The same is true for <em>brush entities</em>, i.e. entities that are made from brushes. For example, if you make a <code>func_wall</code> or <code>func_door</code> entity and place it so that it appears to contribute to the outside wall, <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> will still report a leak, because only the global “world” brushes are taken into account for the sealing hull.
</p>

<p>
As shown in the image, the proper solution is to use the <code>Textures/meta/caulk</code> and other materials like walls and skies to make a “containing room” around such primitives and entities. The <code>Textures/meta/caulk</code> material is especially useful in such cases because it seals the map but doesn&#039;t render (is invisible) in the engine later.
</p>

<p>
The <a href="/mapping:cawe:editingtools:newterrain#the_new_terrain_tool" class="wikilink1" title="mapping:cawe:editingtools:newterrain">New Terrain tool</a> assists you with constructing new terrains that have a proper containing room right from the start, and you may want to have a look at the <code>TechDemo.<abbr title="Cafu Map File. Create them with CaWE, turn them into cw files with CaBSP.">cmap</abbr></code> for a properly sealed terrain example.
<br style="clear:both" />
</p>

<p>
<a href="/_detail/mapping:cawe:leak_example_badbrush.png?id=mapping%3Acawe%3Aleaks" class="media" title="mapping:cawe:leak_example_badbrush.png"><img src="/_media/mapping:cawe:leak_example_badbrush.png?w=438&amp;tok=aa949a" class="mediaright" title="A leak caused by bad brushes (click image to enlarge)." alt="A leak caused by bad brushes (click image to enlarge)." width="438" /></a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Terrains, Bezier Patches and Entities&quot;,&quot;hid&quot;:&quot;terrains_bezier_patches_and_entities&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;3014-4340&quot;} -->
<h3 class="sectionedit7">Leaks due to bad brushes</h3>
<div class="level3">

<p>
Sometimes leaks can also be caused by bad brushes like the one shown in this example (click image to enlarge).
Such leaks are the most problematic: They are very hard to see visually, and they can get <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> thoroughly confused<sup><a href="#fn__1" class="fn_top">1)</a></sup>.
Even worse, usually not much helps but deleting the offending brush, and make it anew with the <a href="/mapping:cawe:editingtools:newbrush#the_new_brush_tool" class="wikilink1" title="mapping:cawe:editingtools:newbrush">New Brush</a> and other tools.
</p>

<p>
On the other hand, the occurrence of such bad brushes is rare. They sometimes exist as the result of importing a map from another game or editor, but are hard to create accidently in <abbr title="Cafu World Editor">CaWE</abbr>. As mentioned before, the best solution is to re-make the offending brushes, or put them into a separate entity, because only the world brushes contribute to the sealing hull, whereas the entities are treated independently.
<br style="clear:both" />
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Leaks due to bad brushes&quot;,&quot;hid&quot;:&quot;leaks_due_to_bad_brushes&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;4341-5372&quot;} -->
<h2 class="sectionedit8">Effects of a Leak</h2>
<div class="level2">

<p>
If your map has a leak, the <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> compiler will automatically detect it and consequently abort the compilation with an error message like this (if there is more than one leak in the map, only the first leak will be reported):
</p>
<pre class="code">*** Fill Inside ***                                 0: 0: 1

### LEAK DETECTED! ###

A leak is a hole in the world, where the inside of it is exposed to the
(unwanted) outside region. Thus, a leak pointfile has been generated.
Load this file into the world editor CaWE, and find the beginning of the line.
Hint: The beginning is always near one of the &quot;info_player_start&quot; entities.
Then find and fix the leak by tracing the line until you reach the outside.
(The line always takes the shortest path, so this should be easy.)

Notes:
- Leaks can be *very* small. Use a close-up view, if necessary.
- Use the grid. The grid is useful to fix leaks + to avoid them from the start.
- Make sure that *all* &quot;info_player_start&quot; entities are inside the world!
- Be aware that both the clip hull and the draw hull must be sealed.
- Please refer to the documentation for additional information.

Pointfile written to Games\DeathMatch\Maps\LeakDemo.pts

FATAL ERROR: Stopped by leak.
Program aborted.</pre>

<p>
That means that with a leak in the map, you cannot run the map at all. As <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> doesn&#039;t write any output file in this case (except for the above mentioned pointfile), neither the subsequent compilers (<abbr title="Cafu Potentially Visibility Set">CaPVS</abbr> and <abbr title="Cafu Radiosity Lighting">CaLight</abbr>), nor the Cafu engine itself can run the map.
</p>

<p>
Future versions of <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> may reduce the severity level of the occurrence of a leak from an error to a mere warning. This will allow you to run your map with Cafu even if it has leaks, but nonetheless will leaks remain a problem that should be fixed. Leaks always indicate that the map could not be optimally processed, and thus imply higher polygon counts and lower performance.
</p>

<p>
The next section will tell you how to find the leaks reported by <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> in the map.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Effects of a Leak&quot;,&quot;hid&quot;:&quot;effects_of_a_leak&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;5373-7366&quot;} -->
<h2 class="sectionedit9">Locating Leaks in the Map</h2>
<div class="level2">

<p>
Finding leaks is very easy: When <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> reports that it found a leak (see example error message and description above), it also creates a corresponding <em>pointfile</em>.
A pointfile is an auxiliary file that contains the description of a trail from one of the <code>info_player_start</code> entities to the outside. The leak is always located somewhere along that path.
</p>

<p>
For loading the pointfile into <abbr title="Cafu World Editor">CaWE</abbr>, simply open the relevant map in <abbr title="Cafu World Editor">CaWE</abbr> (<strong>File → Open…</strong>, if you haven&#039;t already), then select the <strong>Map → Load Pointfile</strong> menu item. <abbr title="Cafu World Editor">CaWE</abbr> assumes that you&#039;ll want to load the recently created pointfile for the currently open map, and thus asks for confirmation, e.g. like this: <br/>

<a href="/_detail/mapping:cawe:leak_loaddefaultpointfile.png?id=mapping%3Acawe%3Aleaks" class="media" title="mapping:cawe:leak_loaddefaultpointfile.png"><img src="/_media/mapping:cawe:leak_loaddefaultpointfile.png" class="medialeft" title="Load the default pointfile?" alt="Load the default pointfile?" /></a> Click “Yes” (“Ja”) to open the suggested default pointfile, which is normally the desired action. Clicking “No” (“Nein”) will open a file selection dialog where you can choose a different file or cancel. <br style="clear:both" />
</p>

<p>
Here are example screenshots of a pointfile that has been loaded into an (unfinished) map: <br/>

<a href="/_detail/mapping:cawe:leak_pointfile1.png?id=mapping%3Acawe%3Aleaks" class="media" title="mapping:cawe:leak_pointfile1.png"><img src="/_media/mapping:cawe:leak_pointfile1.png?w=300&amp;tok=0159f3" class="medialeft" title="An example of a loaded pointfile." alt="An example of a loaded pointfile." width="300" /></a> <a href="/_detail/mapping:cawe:leak_pointfile2.jpg?id=mapping%3Acawe%3Aleaks" class="media" title="mapping:cawe:leak_pointfile2.jpg"><img src="/_media/mapping:cawe:leak_pointfile2.jpg?w=296&amp;tok=ab4467" class="medialeft" title="An example of a loaded pointfile." alt="An example of a loaded pointfile." width="296" /></a> (Click on the images to enlarge them.) <br style="clear:both" />
</p>

<p>
Use the 2D views and especially the 3D camera view (see <a href="/mapping:cawe:views#d_and_3d_views" class="wikilink1" title="mapping:cawe:views">2D and 3D Views</a> for details) to follow the trail from the starting point near one of the <code>info_player_start</code> entities to the place where the line leaves the inside of the map and escapes to the outside. Fix the so found leak however seems appropriate.
</p>

<p>
You may notice that loading the pointfile can decrease the rendering performance in <abbr title="Cafu World Editor">CaWE</abbr>, especially if the trail is very long. Therefore, once you&#039;ve found the leak, you can unload the pointfile again by selecting the <strong>Map → Unload Pointfile</strong> menu item.
</p>

<p>
Finally, restart the compilation (<abbr title="Cafu Binary Space Partitioning">CaBSP</abbr>) to check if the map is now completely sealed or if there are more leaks.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Locating Leaks in the Map&quot;,&quot;hid&quot;:&quot;locating_leaks_in_the_map&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:9,&quot;range&quot;:&quot;7367-9364&quot;} -->
<h2 class="sectionedit10">Preventing Leaks</h2>
<div class="level2">

<p>
The best way to deal with leaks is to prevent them right from the start.
Here is a list of suggestions and considerations in this regard:
</p>
<ol>
<li class="level1"><div class="li"> Use the grid (<strong>Map → Show grid</strong>) and turn on grid snapping (<strong>Map → Snap to grid</strong>). <br/>
The grid and grid snapping are your most powerful allies when it comes to see and avoid leaks while you&#039;re constructing your map.</div>
</li>
<li class="level1"><div class="li"> Run the <strong>Map → Check for Problems</strong> menu item occassionally and before compiling your map.</div>
</li>
<li class="level1"><div class="li"> Avoid all tools that potentially introduce rounding errors and thus misaligned brushes. As a gross guideline, all tools that operate on the grid and that are supposed to <em>produce results on the grid</em> are usually safe, such as resizing rectangular blocks, shearing, vertex manipulation, mirroring, clipping and carving. The following operations are sometimes less safe: Arbitrary (any angle) rotation and clipping and carving when the result has vertices that are off-grid. <br/>
For less-safe operations it is often better to try to mimic the same effect with the safer operations. For example, when you want to carve an arched door into a wall, cutting and placing the wall brushes manually is often better than employing the (more convenient) <strong>Tools → Carve</strong> tool.</div>
</li>
</ol>

<p>
Note that leaks are <em><strong>not</strong></em> <img src="/lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> prevented or fixed by putting the <em>entire map</em> into a big box, even if the strategy that has been suggested above for working properly with terrains might make you think so. Although putting everything into a big box will make <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr> compile the map successfully and thus seemingly fix the leak, the problems associated with a leak (e.g. high polygon count and bad performance) will persist. This is not a solution.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Preventing Leaks&quot;,&quot;hid&quot;:&quot;preventing_leaks&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:10,&quot;range&quot;:&quot;9365-11085&quot;} -->
<h2 class="sectionedit11">Conclusion</h2>
<div class="level2">

<p>
Being able to load the <abbr title="Cafu Binary Space Partitioning">CaBSP</abbr>-generated pointfiles directly into <abbr title="Cafu World Editor">CaWE</abbr> makes finding and fixing leaks relatively easy. However, one of the most important aspects about fixing leaks is to prevent them right from the start.
</p>

<p>
Working carefully and making sure that brushes are properly aligned (snapped) to the grid can help significantly with avoiding leaks even before they occur. The cleaner and more organized you build your geometry, the easier will it be for you to not build them accidently into your map in the first place, and when they still occur, the easier they are to locate and fix.
</p>

<p>
In general, it&#039;s also a good idea to occasionally test-compile your map while it is only partially complete and still a work-in-progress. Besides that this will help you to fine-tune your geometry, it will also point out leaks one at a time, which makes finding and fixing a lot simpler and faster than later when your map is large and fully detailed.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Conclusion&quot;,&quot;hid&quot;:&quot;conclusion&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:11,&quot;range&quot;:&quot;11086-12057&quot;} -->
<h2 class="sectionedit12">See Also</h2>
<div class="level2">

<p>
<a href="http://www.cafu.de/flash/Dealing_with_Leaks.htm" class="media" title="http://www.cafu.de/flash/Dealing_with_Leaks.htm" rel="nofollow"><img src="/_media/starttutorial.png" class="medialeft" title="Start Tutorial" alt="Start Tutorial" /></a>
</p>

<p>
<a href="http://www.cafu.de/flash/Dealing_with_Leaks.htm" class="urlextern" title="http://www.cafu.de/flash/Dealing_with_Leaks.htm" rel="nofollow">Flash Tutorial</a> – A short flash tutorial that presents the essentials about dealing with leaks.
<br style="clear:both" />
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;See Also&quot;,&quot;hid&quot;:&quot;see_also&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:12,&quot;range&quot;:&quot;12058-&quot;} --><div class="footnotes">
<div class="fn"><sup><a href="#fnt__1" class="fn_bot">1)</a></sup> 
<div class="content">If you ever experience such a case and cannot get it fixed by remaking the offending brushes, <a href="http://forum.cafu.de" class="urlextern" title="http://forum.cafu.de" rel="nofollow">let us know</a>. Please include the related map as an attachment.</div></div>
</div>
