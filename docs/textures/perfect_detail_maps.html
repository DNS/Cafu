
<h1 class="sectionedit1" id="making_perfect_detail-maps">Making &quot;perfect&quot; Detail-Maps</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Making \&quot;perfect\&quot; Detail-Maps&quot;,&quot;hid&quot;:&quot;making_perfect_detail-maps&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-44&quot;} -->
<h2 class="sectionedit2">The Problem</h2>
<div class="level2">

<p>
<a href="/_detail/textures:perfectdetailmap-original.png?id=textures%3Aperfect_detail_maps" class="media" title="textures:perfectdetailmap-original.png"><img src="/_media/textures:perfectdetailmap-original.png?w=200&amp;h=200&amp;tok=1f096c" class="mediaright" alt="" width="200" height="200" /></a> Detail-maps, in order to work well, must meet two requirements:
</p>
<ol>
<li class="level1"><div class="li"> Their average value must be 128 (50%) so that they don&#039;t change the total brightness of the texture they&#039;ll be applied to, and</div>
</li>
<li class="level1"><div class="li"> they must not show tile patterns when they are minified (e.g. when they&#039;re viewed from a great distance).</div>
</li>
</ol>

<p>
Getting 1. right is the task of the artist, and is easily done in any paint program that supports contrast and brightness adjustments and histogram views.
</p>

<p>
Getting 2. right is more difficult if not impossible for the artist. For example, I started with the original detail map shown at the right (click to enlarge). Observe that this detail-map has a big dark spot roughly in the mid of the right half. <br style="clear:both" />
</p>

<p>
<a href="/_detail/textures:perfectdetailmap-originalscreen.jpg?id=textures%3Aperfect_detail_maps" class="media" title="textures:perfectdetailmap-originalscreen.jpg"><img src="/_media/textures:perfectdetailmap-originalscreen.jpg?w=200&amp;h=200&amp;tok=77c627" class="mediaright" title="perfectdetailmap-originalscreen.jpg" alt="perfectdetailmap-originalscreen.jpg" width="200" height="200" /></a> This screenshot shows the effect of applying the detail-map to a large terrain. Note the well-visible pattern both on the near ground as well as on the far rocks. This strong pattern is caused by the non-balancedness of the detail texture.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;The Problem&quot;,&quot;hid&quot;:&quot;the_problem&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;45-1139&quot;} -->
<h2 class="sectionedit3">The Idea</h2>
<div class="level2">

<p>
If we had a low-frequency graymap E that just represents the “error” in the above detail-map,
we could subtract that error-map from the detail map D to just remove the error, and then add 128 (50%)
to move the remaining high-frequency parts around 0 back to the average of 128.
That is, the perfectly fixed detail map is found by computing D - E + 128. <br style="clear:both" />
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;The Idea&quot;,&quot;hid&quot;:&quot;the_idea&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;1140-1524&quot;} -->
<h2 class="sectionedit4">The Solution</h2>
<div class="level2">

<p>
First, observe that E is easily found by blurring a copy of D! Any paint program can easily do that! I used The Gimp to apply a Gaussian blur filter to the detail map, creating test images with filter widths of 5, 20, 40 and 60 pixels respectively. The left image below shows my so obtained “E”, which is the original detail-map blurred with a 60 pixels width Gauss filter!
</p>

<p>
The next problem is that computing the above D - E + 128 has a tendency to produce intermediate values that are less than 0 or greater than 255.
Therefore, this operation can <strong>not</strong> be done with layer techniques in PhotoShop, PaintShop, Gimp, etc.!
</p>

<p>
In order to get correct results easily, I just wrote a small C++ program that reads E and D from two images files on disk, computes D - E + 128, and writes the result back into a third file.
Please send me an email if you&#039;re interested in the exe file for Windows!
</p>

<p>
And yes, that&#039;s all!  I applied my program to the above detail-map D and it&#039;s error-map E (left image below). The center image below shows the result. <em>Notice how beautifully the dark spot is gone!</em> In the right image you see a screenshot of the same scene as above, now with the new detail-map being applied. Note that the pattern is (almost) entirely gone!
</p>

<p>
Also please note that now you see a new “pattern” at the mountains – this is the result of a not-so-good base texture that is showing up now that the broken pattern of the detail-map has been fixed and does not any longer distract from it. This matter is not related to detail-map issues, and is just fixed by using a better base texture.
</p>

<p>
<a href="/_detail/textures:perfectdetailmap-blurred60.png?id=textures%3Aperfect_detail_maps" class="media" title="textures:perfectdetailmap-blurred60.png"><img src="/_media/textures:perfectdetailmap-blurred60.png?w=200&amp;h=200&amp;tok=5b2db6" class="media" alt="" width="200" height="200" /></a> <a href="/_detail/textures:perfectdetailmap-result60.png?id=textures%3Aperfect_detail_maps" class="media" title="textures:perfectdetailmap-result60.png"><img src="/_media/textures:perfectdetailmap-result60.png?w=200&amp;h=200&amp;tok=37dde7" class="media" alt="" width="200" height="200" /></a> <a href="/_detail/textures:perfectdetailmap-result60screen.jpg?id=textures%3Aperfect_detail_maps" class="media" title="textures:perfectdetailmap-result60screen.jpg"><img src="/_media/textures:perfectdetailmap-result60screen.jpg?w=200&amp;h=200&amp;tok=5c7c67" class="media" title="perfectdetailmap-result60screen.jpg" alt="perfectdetailmap-result60screen.jpg" width="200" height="200" /></a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;The Solution&quot;,&quot;hid&quot;:&quot;the_solution&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1525-3307&quot;} -->
<h2 class="sectionedit5">Discussion and Results</h2>
<div class="level2">

<p>
One open question is how much D should be blurred in order to obtain E. This is easily answered: As much as possible! In the above example, I used a blur filter of 60 pixels width, and the pattern as (almost) completely gone.
Using smaller filter sizes reduces the rests even further. For example, I also made tests with blur filters of 5, 20 and 40 pixels width. The smaller the filter kernel width was, the more homogeneous became the end result. (Blurring not at all obviously yields the 128 planar detail map (because then E=D, and D-D+128 = 128) and has no visual impact at all!)
</p>

<p>
Therefore, the recommended strategy is to start with a really big amount of blurring, and only reduce it if that amount was not sufficient to remove the most significant non-balancedness of the original detail-map.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Discussion and Results&quot;,&quot;hid&quot;:&quot;discussion_and_results&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;3308-4144&quot;} -->
<h2 class="sectionedit6">High-Pass Filters in PhotoShop</h2>
<div class="level2">

<p>
After I had completed this article, Kai sent me a link to this Gamasutra site: <a href="http://www.gamasutra.com/features/20010523/hajba_01.htm" class="urlextern" title="http://www.gamasutra.com/features/20010523/hajba_01.htm" rel="nofollow">http://www.gamasutra.com/features/20010523/hajba_01.htm</a>
It deals with the same problem and is a lot more detailed than this text – definitively a recommended read!
As the solution, High-Pass Filters are presented which achieve exactly the same results and which are – contrary to my above statements – well built into PhotoShop and possibly other paint programs, too. So if you&#039;re a dedicated user of your favourite paint program, you&#039;ll probably want to give the built-in high-pass filter a try before trying my home-grown solution.  <img src="/lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" />
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;High-Pass Filters in PhotoShop&quot;,&quot;hid&quot;:&quot;high-pass_filters_in_photoshop&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;4145-&quot;} -->